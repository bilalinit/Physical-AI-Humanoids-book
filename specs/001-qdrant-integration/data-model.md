# Data Model: Qdrant Vector Database Integration

## Entities

### Book Content Chunk
**Description**: A segment of book text that has been processed and converted to vector embeddings for semantic search

**Fields**:
- `id` (string): Unique identifier for the chunk in Qdrant
- `filename` (string): Relative path of the source markdown file
- `text` (string): The actual text content of the chunk (up to 1000 characters)
- `chunk_number` (integer): Position of this chunk within the document
- `total_chunks` (integer): Total number of chunks in the original document
- `vector` (array[float]): 768-dimensional embedding vector representation of the text
- `created_at` (timestamp): When this chunk was created/ingested

**Validation rules**:
- `text` must be between 1 and 1000 characters
- `chunk_number` must be between 1 and `total_chunks`
- `vector` must have exactly 768 dimensions

### Vector Embedding
**Description**: Numerical representation of text content that enables semantic similarity search

**Fields**:
- `vector` (array[float]): 768-dimensional array of float values
- `text` (string): Original text that was embedded
- `task_type` (string): Type of embedding task (e.g., "retrieval_query", "retrieval_document")

**Validation rules**:
- `vector` must have exactly 768 dimensions
- `task_type` must be one of the supported Gemini embedding task types

### RAG Response
**Description**: Response generated by the RAG system that includes both answer and source information

**Fields**:
- `output` (string): The generated response to the user's query
- `context_chunks` (array): List of chunks that were used to generate the response
- `sources` (array): List of source documents referenced in the response
- `query_embedding` (array[float]): The vector representation of the user's query

**Validation rules**:
- `output` must not be empty
- `context_chunks` must contain at least one chunk when sources are provided

### Qdrant Collection
**Description**: Container in the vector database storing book content chunks with their embeddings

**Fields**:
- `name` (string): Name of the collection (e.g., "book_content")
- `vector_size` (integer): Size of the vectors (768 for Gemini embeddings)
- `distance` (string): Distance function used for similarity search (cosine)

**Validation rules**:
- `vector_size` must match the embedding dimension (768)
- `distance` must be compatible with the embedding model

## Relationships

- One source document → Many book content chunks (1:N)
- Many book content chunks → One RAG response (N:1 during query time)
- One vector embedding → One book content chunk (1:1)

## State Transitions

### Book Content Chunk States
- `PENDING`: Chunk created but not yet embedded
- `EMBEDDED`: Chunk has been processed and vector created
- `INDEXED`: Chunk has been uploaded to Qdrant and is searchable
- `FAILED`: Chunk processing failed and requires reprocessing

## API Endpoints

### POST /api/chat
**Purpose**: Process user query using RAG and return response with citations
**Input**: `{user_query, selected_text?, chat_history?}`
**Output**: `{output, context_chunks, sources}`

### GET /api/search
**Purpose**: Direct vector search in Qdrant
**Input**: `{query, limit?, score_threshold?}`
**Output**: Array of matching chunks with metadata

### POST /api/ingest
**Purpose**: Ingest book content into vector database
**Input**: `{docs_path}`
**Output**: `{status, processed_files, errors?}`