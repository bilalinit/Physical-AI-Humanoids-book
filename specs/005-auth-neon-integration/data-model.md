# Data Model: Better Auth + Neon Integration

**Feature**: 005-auth-neon-integration
**Date**: 2025-12-13

## Entities

### 1. User
Represents an authenticated user of the system with learning preferences.

**Attributes**:
- `id` (TEXT, PRIMARY KEY): UUID string generated by Better Auth
- `email` (TEXT, UNIQUE, NOT NULL): User's email address
- `name` (TEXT, NOT NULL): User's full name
- `educationLevel` (TEXT): Education level enum: "High School", "Undergraduate", "Graduate", "Professional"
- `programmingExperience` (TEXT): Programming experience enum: "No Experience", "Beginner", "Intermediate", "Advanced"
- `softwareBackground` (TEXT): Software background description (free text)
- `hardwareBackground` (TEXT): Hardware background description (free text)
- `roboticsBackground` (TEXT): Robotics background enum: "No Experience", "Hobbyist", "Academic", "Professional"
- `createdAt` (TIMESTAMP): Account creation timestamp (default: NOW())

**Validation Rules**:
- Email must be valid format (RFC 5322)
- Name must be 2-100 characters
- Password must be at least 8 characters (handled by Better Auth)
- Learning preference fields must be one of allowed enum values

**State Transitions**:
- `unregistered` → `registered` (on signup)
- `registered` → `authenticated` (on login)
- `authenticated` → `logged_out` (on logout or session expiry)

### 2. Session
Represents an active user authentication session.

**Attributes**:
- `id` (TEXT, PRIMARY KEY): UUID string generated by Better Auth
- `userId` (TEXT, FOREIGN KEY): References `User.id` with ON DELETE CASCADE
- `token` (TEXT): Session authentication token
- `expiresAt` (TIMESTAMP, NOT NULL): Session expiration timestamp

**Relationships**:
- Many-to-one with User: One user can have multiple sessions
- Cascade delete: When user is deleted, all their sessions are deleted

**Validation Rules**:
- Token must be unique
- Expiration must be in the future when created
- User must exist (foreign key constraint)

### 3. ChatHistory
Represents a saved conversation between a user and the AI assistant.

**Attributes**:
- `id` (SERIAL, PRIMARY KEY): Auto-incrementing integer
- `userId` (TEXT, FOREIGN KEY, NOT NULL): References `User.id` with ON DELETE CASCADE
- `message` (TEXT, NOT NULL): User's question/message to the chatbot
- `response` (TEXT, NOT NULL): AI assistant's response
- `selectedText` (TEXT, NULLABLE): Text selected from documentation (optional context)
- `createdAt` (TIMESTAMP, NOT NULL): Message timestamp (default: NOW())

**Relationships**:
- Many-to-one with User: One user can have many chat history entries
- Cascade delete: When user is deleted, all their chat history is deleted

**Validation Rules**:
- Message must be 1-5000 characters
- Response must be 1-10000 characters
- Selected text must be 0-2000 characters (optional)
- Created timestamp must be current or in the past

## Database Schema

### Table Definitions
```sql
-- User table (Better Auth compatible)
CREATE TABLE "user" (
    "id" TEXT PRIMARY KEY,
    "email" TEXT NOT NULL UNIQUE,
    "name" TEXT NOT NULL,
    "educationLevel" TEXT,
    "programmingExperience" TEXT,
    "softwareBackground" TEXT,
    "hardwareBackground" TEXT,
    "roboticsBackground" TEXT,
    "createdAt" TIMESTAMP DEFAULT NOW()
);

-- Session table (Better Auth compatible)
CREATE TABLE "session" (
    "id" TEXT PRIMARY KEY,
    "userId" TEXT NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
    "token" TEXT,
    "expiresAt" TIMESTAMP NOT NULL
);

-- Chat history table
CREATE TABLE "chat_history" (
    "id" SERIAL PRIMARY KEY,
    "userId" TEXT NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
    "message" TEXT NOT NULL,
    "response" TEXT NOT NULL,
    "selectedText" TEXT,
    "createdAt" TIMESTAMP NOT NULL DEFAULT NOW()
);
```

### Indexes for Performance
```sql
-- User table indexes
CREATE INDEX idx_user_email ON "user"("email");
CREATE INDEX idx_user_created_at ON "user"("createdAt" DESC);

-- Session table indexes
CREATE INDEX idx_session_user_id ON "session"("userId");
CREATE INDEX idx_session_expires_at ON "session"("expiresAt");
CREATE INDEX idx_session_token ON "session"("token");

-- Chat history table indexes
CREATE INDEX idx_chat_history_user_id ON "chat_history"("userId");
CREATE INDEX idx_chat_history_created_at ON "chat_history"("createdAt" DESC);
CREATE INDEX idx_chat_history_user_created ON "chat_history"("userId", "createdAt" DESC);
```

### Constraints
```sql
-- User constraints
ALTER TABLE "user" ADD CONSTRAINT chk_user_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$');
ALTER TABLE "user" ADD CONSTRAINT chk_user_name_length CHECK (LENGTH("name") BETWEEN 2 AND 100);

-- Education level enum constraint
ALTER TABLE "user" ADD CONSTRAINT chk_education_level
    CHECK ("educationLevel" IN ('High School', 'Undergraduate', 'Graduate', 'Professional') OR "educationLevel" IS NULL);

-- Programming experience enum constraint
ALTER TABLE "user" ADD CONSTRAINT chk_programming_experience
    CHECK ("programmingExperience" IN ('No Experience', 'Beginner', 'Intermediate', 'Advanced') OR "programmingExperience" IS NULL);

-- Robotics background enum constraint
ALTER TABLE "user" ADD CONSTRAINT chk_robotics_background
    CHECK ("roboticsBackground" IN ('No Experience', 'Hobbyist', 'Academic', 'Professional') OR "roboticsBackground" IS NULL);

-- Chat history constraints
ALTER TABLE "chat_history" ADD CONSTRAINT chk_message_length CHECK (LENGTH("message") BETWEEN 1 AND 5000);
ALTER TABLE "chat_history" ADD CONSTRAINT chk_response_length CHECK (LENGTH("response") BETWEEN 1 AND 10000);
ALTER TABLE "chat_history" ADD CONSTRAINT chk_selected_text_length CHECK (LENGTH("selectedText") BETWEEN 0 AND 2000 OR "selectedText" IS NULL);
```

## Data Access Patterns

### Common Queries

1. **User Authentication**:
   ```sql
   -- Validate user credentials (handled by Better Auth)
   SELECT * FROM "user" WHERE "email" = ?;

   -- Create session
   INSERT INTO "session" ("id", "userId", "token", "expiresAt") VALUES (?, ?, ?, ?);
   ```

2. **Session Validation**:
   ```sql
   -- Validate session token
   SELECT u.*, s."expiresAt"
   FROM "session" s
   JOIN "user" u ON s."userId" = u."id"
   WHERE s."token" = ? AND s."expiresAt" > NOW();
   ```

3. **Chat History Operations**:
   ```sql
   -- Save chat message
   INSERT INTO "chat_history" ("userId", "message", "response", "selectedText")
   VALUES (?, ?, ?, ?)
   RETURNING "id", "createdAt";

   -- Retrieve user's chat history (paginated)
   SELECT "id", "message", "response", "selectedText", "createdAt"
   FROM "chat_history"
   WHERE "userId" = ?
   ORDER BY "createdAt" DESC
   LIMIT ? OFFSET ?;

   -- Count user's chat messages
   SELECT COUNT(*) FROM "chat_history" WHERE "userId" = ?;
   ```

4. **User Profile Management**:
   ```sql
   -- Get user profile
   SELECT "id", "email", "name", "educationLevel", "programmingExperience",
          "softwareBackground", "hardwareBackground", "roboticsBackground", "createdAt"
   FROM "user"
   WHERE "id" = ?;

   -- Update learning preferences
   UPDATE "user"
   SET "educationLevel" = ?, "programmingExperience" = ?, "roboticsBackground" = ?,
       "softwareBackground" = ?, "hardwareBackground" = ?
   WHERE "id" = ?;
   ```

## Migration Considerations

### From In-Memory to Persistent Storage
1. **Data Compatibility**: Existing in-memory threads use different ID format (string vs UUID)
2. **User Mapping**: Anonymous users have no persistent user ID
3. **Transition Strategy**: Dual-write during migration period

### Data Retention Policy
- **Chat History**: Keep last 50 messages per user (configurable)
- **Sessions**: Auto-expire based on `expiresAt` timestamp
- **Users**: Keep indefinitely unless manually deleted

### Backup and Recovery
- **Regular Backups**: Neon PostgreSQL automated backups
- **Point-in-Time Recovery**: Supported by Neon
- **Export**: JSON export of chat history for user data portability

## Security Considerations

### Data Protection
- **Passwords**: Hashed by Better Auth using bcrypt
- **Sessions**: Secure random tokens with expiration
- **Personal Data**: Email and name stored as provided

### Access Control
- **User Data**: Only accessible by owning user (via user ID)
- **Chat History**: User-specific with foreign key constraints
- **Admin Access**: No built-in admin interface in initial implementation

### Compliance
- **GDPR**: User data deletion via cascade delete
- **Data Minimization**: Only collect necessary learning preferences
- **Transparency**: Clear privacy policy about data usage